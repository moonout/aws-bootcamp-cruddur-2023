#!/usr/bin/env python

import sys
import boto3
import json
import datetime

MESSAGE_GROUP_UUID = "366a3727-4f86-4482-8229-979fa59b17ab"
TABLE_NAME = "cruddur-messages"


if len(sys.argv) == 2 and sys.argv[1] == "prod":
    attrs = {}
else:
    attrs = {"endpoint_url": "http://localhost:8000"}
ddb_client = boto3.client("dynamodb", **attrs)


query_params = {
    "TableName": TABLE_NAME,
    "KeyConditionExpression": "pk = :pkey AND begins_with(sk, :year)",
    "ScanIndexForward": False,
    "Limit": 50,
    "ExpressionAttributeValues": {":pkey": {"S": f"MSG#{MESSAGE_GROUP_UUID}"}, ":year": {"S": "2023-04-02T18:1"}},
    "ReturnConsumedCapacity": "TOTAL",
}

# query the table
response = ddb_client.query(**query_params)


print(json.dumps(response["ConsumedCapacity"], sort_keys=True, indent=2))

items = response["Items"]

for item in reversed(items):
    sender_handle = item["user_handle"]["S"]
    message = item["message"]["S"]
    timestamp = item["sk"]["S"]
    dt_object = datetime.datetime.strptime(timestamp, "%Y-%m-%dT%H:%M:%S.%f%z")
    formatted_datetime = dt_object.strftime("%Y-%m-%d %H:%M")
    print(f"{sender_handle: <16}{formatted_datetime: <22}{message[:40]}...", timestamp)
